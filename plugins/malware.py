import psutil
import tempfile
import glob
import mimetypes

LINEBREAK = "\n"
class malware:
    def config(self):
        result = "graph_title Script host processes (cscript.exe and wscript.exe)" + LINEBREAK
        result += "graph_vlabel Process count" + LINEBREAK
        result += "graph_category malware" + LINEBREAK
        result += "exe.label potential dropper payload in %TEMP%" + LINEBREAK
        result += "exe.type GAUGE" + LINEBREAK 
        result += "wscript.label WScript Processes" + LINEBREAK
        result += "wscript.type GAUGE" + LINEBREAK 
        result += "cscript.label CScript Processes" + LINEBREAK
        result += "cscript.type GAUGE"
        return result
    
    def isExePresent(self):
        temp = tempfile.gettempdir() + "\\"
        for filename in glob.iglob(temp + '*', recursive=True):
                fileType,fileEncoding = mimetypes.guess_type(filename)
                if fileType == "application/octet-stream" or fileType == "application/x-msdownload":
                    return True
        
        return False

    def fetch(self):
        exePresent = 0
        if self.isExePresent():
            exePresent  = 1 # we don't care about the real amount
        wscript = 0
        cscript = 0
        for proc in psutil.process_iter(attrs=['pid', 'name']):
               if proc.info['name'].lower() == 'wscript.exe':
                   wscript += 1
               if proc.info['name'].lower() == 'cscript.exe':
                   cscript += 1 
        result = "exe.value " + str(exePresent) + LINEBREAK
        result += "wscript.value " + str(cscript) + LINEBREAK
        result += "cscript.value " + str(wscript) 
        return result 